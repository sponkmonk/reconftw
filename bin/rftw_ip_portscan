#!/bin/bash

# Default config path
CONFIG_PATH="${RECONFTW_CFG}"

# Check if the config file exists
if [[ -f "${CONFIG_PATH}" ]]; then
    source "${CONFIG_PATH}"
else
    echo "Error: reconftw.cfg not found at ${CONFIG_PATH}!"
    exit 1
fi
# Help menu
display_help() {
	echo "$(basename "$0") [Options]"
	echo
	echo "  -f, --file              File containing IPs for port scan (Required)"
	echo "  -o, --output-dir        Output dir location"
	echo "  -h, --help              Display this help and exit"
	echo
	echo "Example: $0 -f file.txt -o dir"
	exit 1
}

# Variables for input and output
output_dir=""

# Parse input arguments
while [[ $# -gt 0 ]]; do
	case $1 in
	-f | --file)
		DOMAIN_FILE="$2"
		shift
		;;
	-o | --output)
		output_dir="$2"
		shift
		;;
	-h | --help) display_help ;;
	*)
		echo "Unknown parameter passed: $1"
		exit 1
		;;
	esac
	shift
done

# Input validation
if [[ -z ${DOMAIN_FILE} ]] ; then
	display_help
	exit 1
fi

# Validate file
if [[ ! -f ${DOMAIN_FILE} ]] || [[ ! -r ${DOMAIN_FILE} ]]; then
	echo "Error: Specified file does not exist or is not readable."
	exit 1
fi

mkdir -p .tmp 2>/dev/null
cdncheck -silent -resp -nc <${DOMAIN_FILE} 2>/dev/null >${output_dir}/cdn_providers.txt
comm -23 <(sort -u ${DOMAIN_FILE}) <(cut -d'[' -f1 ${output_dir}/cdn_providers.txt | sed 's/[[:space:]]*$//' | sort -u) | grep -aEiv "^(127|10|169\.154|172\.1[6789]|172\.2[0-9]|172\.3[01]|192\.168)\." | grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" | sort -u | anew -q .tmp/ips_nocdn.txt
printf "${bblue}\n Resolved IP addresses (No CDN) ${reset}\n\n"
[[ -s ".tmp/ips_nocdn.txt" ]] && sort .tmp/ips_nocdn.txt
printf "${bblue}\n Scanning ports... ${reset}\n\n"
if [[ $PORTSCAN_PASSIVE == true ]] && [[ ! -f "${output_dir}/portscan_passive.txt" ]] && [[ -s ".tmp/ips_nocdn.txt" ]]; then
	smap -iL .tmp/ips_nocdn.txt >${output_dir}/portscan_passive.txt 2>/dev/null
fi
if [[ $PORTSCAN_ACTIVE == true ]]; then
	if [[ ${AXIOM} == true ]]; then
		[[ -s ".tmp/ips_nocdn.txt" ]] && axiom-scan .tmp/ips_nocdn.txt -m nmapx --top-ports 200 -sV -n -Pn --open --max-retries 2 --script vulners -oA ${output_dir}/portscan_active "${AXIOM_EXTRA_ARGS}" 2>/dev/null
	else
		[[ -s ".tmp/ips_nocdn.txt" ]] && $SUDO nmap --top-ports 200 -sV -n --max-retries 2 -Pn --open --script vulners -iL .tmp/ips_nocdn.txt -oA ${output_dir}/portscan_active  2>/dev/null
	fi
fi