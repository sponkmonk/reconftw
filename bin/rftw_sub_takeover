#!/bin/bash

# Default config path
CONFIG_PATH="${RECONFTW_CFG}"

# Check if the config file exists
if [[ -f "${CONFIG_PATH}" ]]; then
    source "${CONFIG_PATH}"
else
    echo "Error: reconftw.cfg not found at ${CONFIG_PATH}!"
    exit 1
fi
# Help menu
display_help() {
	echo "$(basename "$0") [Options]"
	echo
	echo "  -d, --domain            Target for subdomain enumeration (Required)"
	echo "  -f, --file              File containing domains for subdomain enumeration (Required)"
	echo "  -o, --output            Output file location"
	echo "  -h, --help              Display this help and exit"
	echo
	echo "Example: $0 -d example.com -l /path/to/log"
	exit 1
}

# Variables for input and output
output_file=""

# Parse input arguments
while [[ $# -gt 0 ]]; do
	case $1 in
	-d | --domain)
		DOMAIN="$2"
		shift
		;;
	-f | --file)
		DOMAIN_FILE="$2"
		shift
		;;
	-o | --output)
		output_file="$2"
		shift
		;;
	-h | --help) display_help ;;
	*)
		echo "Unknown parameter passed: $1"
		exit 1
		;;
	esac
	shift
done

# Input validation
if [[ -z ${DOMAIN_FILE} ]] || [[ -z ${DOMAIN} ]]; then
	display_help
	exit 1
fi

# Validate file
if [[ ! -f ${DOMAIN_FILE} ]] || [[ ! -r ${DOMAIN_FILE} ]]; then
	echo "Error: Specified file does not exist or is not readable."
	exit 1
fi
# Validate domain
rftw_util_validatedomain "${DOMAIN}" || exit 1 # Domain validation

run_subtakeover() {

	mkdir -p .tmp 2>/dev/null
	if [[ ! ${AXIOM} = true ]]; then
		nuclei -update 2>/dev/null
		cat ${DOMAIN_FILE} | nuclei -silent -nh -tags takeover -severity info,low,medium,high,critical -retries 3 -rl $NUCLEI_RATELIMIT -t ${NUCLEI_TEMPLATES_PATH} -o .tmp/tko.txt 2>/dev/null
	else
		cat ${DOMAIN_FILE} | sed '/^$/d' | anew -q .tmp/webs_subs.txt
		[[ -s ".tmp/webs_subs.txt" ]] && axiom-scan .tmp/webs_subs.txt -m nuclei --nuclei-templates ${NUCLEI_TEMPLATES_PATH} -tags takeover -nh -severity info,low,medium,high,critical -retries 3 -rl $NUCLEI_RATELIMIT -t ${NUCLEI_TEMPLATES_PATH} -o .tmp/tko.txt "${AXIOM_EXTRA_ARGS}" 2>/dev/null
	fi
	# DNS_TAKEOVER
	cat .tmp/subs_no_resolved.txt .tmp/subdomains_dns.txt .tmp/scrap_subs.txt .tmp/analytics_subs_clean.txt .tmp/passive_recursive.txt 2>/dev/null | anew -q .tmp/subs_dns_tko.txt
	cat .tmp/subs_dns_tko.txt 2>/dev/null | dnstake -c $DNSTAKE_THREADS -s | sed '/^$/d' | anew -q ${output_file}
	sed -i '/^$/d' ${output_file}
}

run_subtakeover